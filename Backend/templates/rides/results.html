{% extends "commons/base.html" %}

{% block title %}Triplink - Available Rides{% endblock %}

{% block header_title %}
Rides
{% endblock %}

{% block content %}
<h3 class="text-xl mb-4 font-semibold">
  Rides from <span class="text-secondary">{{ from_city }}</span>
  to <span class="text-secondary">{{ to_city }}</span>
  on <span class="text-secondary">{{ date }}</span>
</h3>

<!-- MESSAGE -->
<div id="bookingMsg" class="hidden mb-4"></div>

{% if rides %}
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
    {% for ride, ride_date, already_booked in rides %}
      <div class="bg-white shadow rounded-lg p-5 flex flex-col space-y-3 border border-gray-200">

        <div class="flex items-center justify-between">
          <span class="text-gray-700">
            <strong>Date:</strong> {{ ride_date }}
          </span>
          <span class="bg-secondary text-white px-3 py-1 rounded">
            {{ ride.price }}â‚¬
          </span>
        </div>

        <div class="text-gray-700">
          <strong>Seats:</strong> {{ ride.available_seats }}
        </div>

        {% if already_booked %}
          <button disabled
                  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed">
            Already booked
          </button>
        {% else %}
          <button
            class="book-btn w-full bg-secondary text-white py-2 rounded hover:bg-primary transition"
            data-ride-id="{{ ride.id }}">
            Book Ride
          </button>
        {% endif %}

      </div>
    {% endfor %}
  </div>
{% else %}
  <p class="text-gray-700 text-lg mt-4">
    No rides found for your search.
  </p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const msg = document.getElementById("bookingMsg");

    document.querySelectorAll(".book-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const rideId = btn.dataset.rideId;

            btn.disabled = true;
            btn.textContent = "Sending...";

            try {
                const res = await fetch(`/bookings/request/${rideId}`, {
                    method: "POST",
                    credentials: "include"
                });

                const data = await res.json();
                msg.classList.remove("hidden");

                if (res.ok) {
                    msg.className = "mb-4 p-3 rounded bg-green-100 text-green-700";
                    msg.textContent = "Booking request sent.";

                    btn.textContent = "Already booked";
                    btn.classList.remove("bg-secondary", "hover:bg-primary");
                    btn.classList.add("bg-gray-400", "cursor-not-allowed");
                } else {
                    msg.className = "mb-4 p-3 rounded bg-red-100 text-red-700";
                    msg.textContent = data.message || "Booking failed.";

                    btn.disabled = false;
                    btn.textContent = "Book Ride";
                }
            } catch {
                msg.className = "mb-4 p-3 rounded bg-red-100 text-red-700";
                msg.textContent = "Network error.";

                btn.disabled = false;
                btn.textContent = "Book Ride";
            }
        });
    });
});
</script>
{% endblock %}
