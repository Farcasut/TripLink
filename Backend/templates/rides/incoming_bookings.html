{% extends "commons/base.html" %}

{% block title %}Triplink - Incoming Bookings{% endblock %}

{% block header_title %}
Incoming Booking Requests
{% endblock %}

{% block content %}

<div id="actionMsg" class="hidden mb-4"></div>

<div class="flex justify-center">
  <div class="w-full max-w-4xl space-y-4">

    {% if bookings|length == 0 %}
      <div class="bg-white p-6 rounded shadow text-center text-gray-600">
        No pending booking requests.
      </div>
    {% else %}
      {% for booking in bookings %}
        <div class="booking-card bg-white p-6 rounded shadow flex justify-between items-center">

          <!-- LEFT -->
          <div class="space-y-1">
            <div class="text-lg font-semibold">
              {{ booking.ride.source }} â†’ {{ booking.ride.destination }}
            </div>

            <div class="text-sm text-gray-600">
              Departure: {{ booking.departure_display }}
            </div>

            <div class="text-sm text-gray-600">
              Available seats: {{ booking.ride.available_seats }}
            </div>

            <div class="text-sm text-gray-700 font-medium">
              Passenger:
              {{ booking.passenger.first_name }}
              {{ booking.passenger.last_name }}
              (<span class="text-gray-500">@{{ booking.passenger.username }}</span>)
            </div>
          </div>

          <!-- RIGHT -->
          <div class="flex space-x-2">
            <button class="accept-btn px-4 py-1.5 bg-green-600 text-white rounded hover:bg-green-700"
                    data-id="{{ booking.id }}">
              Accept
            </button>

            <button class="deny-btn px-4 py-1.5 bg-red-600 text-white rounded hover:bg-red-700"
                    data-id="{{ booking.id }}">
              Deny
            </button>
          </div>

        </div>
      {% endfor %}
    {% endif %}

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const msg = document.getElementById("actionMsg");

    async function handleAction(url, card, successText) {
        try {
            const res = await fetch(url, {
                method: "POST",
                credentials: "include"
            });

            const data = await res.json();
            msg.classList.remove("hidden");

            if (res.ok) {
                msg.className = "mb-4 p-3 rounded bg-green-100 text-green-700";
                msg.textContent = successText;
                card.remove();
            } else {
                msg.className = "mb-4 p-3 rounded bg-red-100 text-red-700";
                msg.textContent = data.message || "Action failed";
            }
        } catch {
            msg.className = "mb-4 p-3 rounded bg-red-100 text-red-700";
            msg.textContent = "Network error";
        }
    }

    document.querySelectorAll(".accept-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            handleAction(
                `/rides/booking/${btn.dataset.id}/accept`,
                btn.closest(".booking-card"),
                "Booking accepted. Passenger notified."
            );
        });
    });

    document.querySelectorAll(".deny-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            handleAction(
                `/rides/booking/${btn.dataset.id}/deny`,
                btn.closest(".booking-card"),
                "Booking denied. Passenger notified."
            );
        });
    });
});
</script>
{% endblock %}
