<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TripLink - Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Message bubbles */
    .msg {
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      max-width: 75%; /* Bubble max width */
      word-break: break-word; /* Wrap long words */
      display: inline-block;
    }

    /* Typing animation dots */
    .typing-dots span {
      display: inline-block;
      width: 0.5rem;
      height: 0.5rem;
      margin: 0 0.1rem;
      background-color: #9ca3af;
      border-radius: 50%;
      animation: bounce 1.2s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden z-30"></div>

    <div id="sidebar"
         class="bg-gray-800 text-white w-64 py-7 px-2 space-y-6
                fixed inset-y-0 left-0 transform -translate-x-full
                transition-transform duration-200 ease-in-out
                z-40">

        <h1 class="text-2xl font-bold text-center mb-8">Triplink</h1>
        
        <nav>
            <a href="/dashboard" class="block py-2.5 px-4 rounded hover:bg-gray-700"> Dashboard </a>
            {% if is_driver %}
                <a href="/rides/create" class="block py-2.5 px-4 rounded hover:bg-gray-700"> Create Ride </a>
                <a href="/rides/all_rides" class="block py-2.5 px-4 rounded hover:bg-gray-700"> My Rides </a>
                <a href="/bookings/incoming" class="block py-2.5 px-4 rounded hover:bg-gray-700"> Incoming Bookings </a>
            {% endif %}
            <a href="/rides" class="block py-2.5 px-4 rounded hover:bg-gray-700"> Search Rides </a>
            <a href="/bookings/my" class="block py-2.5 px-4 rounded hover:bg-gray-700"> My Bookings </a>
            <a href="/chat" class="block py-2.5 px-4 rounded hover:bg-gray-700"> Ride Assistant </a>
        </nav>
    </div>

  <div class="flex-1 flex flex-col">
      <header class="flex justify-between items-center bg-white shadow px-4 py-3">

          <button id="burgerBtn"
              class="text-gray-800 p-2 rounded hover:bg-gray-200 transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
              </svg>
          </button>
          
          <h2 class="absolute left-1/2 -translate-x-1/2 text-xl font-semibold">
              Assistant
          </h2>
      </header>
  </div>

  <div class="flex-1 flex flex-col justify-center items-center p-10">
    <div class="w-full max-w-xl flex flex-col border border-gray-300 rounded-xl bg-white shadow-lg p-4 h-[80vh]">

      <!-- Chat messages -->
      <div id="chat-box" class="flex-1 flex flex-col gap-2 overflow-y-auto mb-4">
        <!-- Messages appended dynamically -->
      </div>

      <!-- Input -->
      <div class="flex gap-2">
        <input 
          id="chat-input" 
          type="text" 
          placeholder="Ask about distances or prices..." 
          class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
        >
        <button id="send-btn" class="bg-blue-600 text-white rounded-xl px-4 py-2 hover:bg-blue-700">Send</button>
      </div>
    </div>
  </div>

  <script>
    const overlay = document.getElementById("overlay");
    const burger = document.getElementById("burgerBtn");
    const sidebar = document.getElementById("sidebar");

    function openSidebar() {
        sidebar.classList.remove("-translate-x-full");
        overlay.classList.remove("hidden");
    }

    function closeSidebar() {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
    }

    burger.addEventListener("click", () => {
        const isOpen = !sidebar.classList.contains("-translate-x-full");
        isOpen ? closeSidebar() : openSidebar();
    });

    overlay.addEventListener("click", closeSidebar);

    const box = document.getElementById("chat-box");
    const input = document.getElementById("chat-input");
    const btn = document.getElementById("send-btn");
    let isTyping = false;

    function setInputDisabled(disabled) {
      input.disabled = disabled;
      btn.disabled = disabled;
      if (disabled) {
        input.classList.add("opacity-50", "cursor-not-allowed");
        btn.classList.add("opacity-50", "cursor-not-allowed");
      } else {
        input.classList.remove("opacity-50", "cursor-not-allowed");
        btn.classList.remove("opacity-50", "cursor-not-allowed");
      }
    }

    function addMessage(text, type) {
      const div = document.createElement("div");
      div.textContent = text;
      div.className = `msg max-w-[75%] p-2 break-words rounded-2xl`;

      if (type === "user") {
        div.classList.add("bg-blue-600", "text-white", "self-end", "border", "border-blue-700");
      } else {
        div.classList.add("bg-gray-200", "text-gray-900", "self-start", "border", "border-gray-300");
      }

      const wrapper = document.createElement("div");
      wrapper.className = "flex";
      wrapper.classList.add(type === "user" ? "justify-end" : "justify-start");
      wrapper.appendChild(div);

      box.appendChild(wrapper);
      box.scrollTop = box.scrollHeight;
    }

    function showTyping() {
      isTyping = true;
      setInputDisabled(true);

      const wrapper = document.createElement("div");
      wrapper.id = "typing-indicator";
      wrapper.className = "flex justify-start";

      const dots = document.createElement("div");
      dots.className = "msg bg-gray-200 text-gray-900 self-start border border-gray-300 rounded-2xl typing-dots flex items-center px-2 py-1";
      for (let i = 0; i < 3; i++) {
        const span = document.createElement("span");
        dots.appendChild(span);
      }

      wrapper.appendChild(dots);
      box.appendChild(wrapper);
      box.scrollTop = box.scrollHeight;
    }

    function hideTyping() {
      const el = document.getElementById("typing-indicator");
      if (el) el.remove();
      isTyping = false;
      setInputDisabled(false);
    }

    async function sendMessage() {
      if (isTyping) return;

      const text = input.value.trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";
      showTyping();

      try {
        const res = await fetch("/chat/message", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },

          body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        hideTyping();
        addMessage(data.reply, "bot");
      } catch (err) {
        hideTyping();
        addMessage("I could not respond.. Try again.", "bot");
      }
    }

    btn.onclick = sendMessage;
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
